% Correlation Plot.
% GJ 2-11-2019

clc;clear all;close all;
%% Main Code Directory location and SLASH of the OS
[main_folder,SLASH]=get_expmainfolder_slash();
%% Adding Path
addpath([main_folder,'dependencies',SLASH,'matconvnet-1.0-beta24']);
addpath([main_folder,'dependencies',SLASH,'models']);
addpath([main_folder,'dependencies',SLASH,'lib']);
run_path=[main_folder,'dependencies',SLASH,'matconvnet-1.0-beta24',SLASH,'matlab',SLASH,'vl_setupnn'];

% stimuli
fprintf('\n Loading Stim File .... \n')
filename_stim = ['..',SLASH,'stim',SLASH,'natural_stim_GJ.mat'];
load(filename_stim);
%% selecting image pairs having third element as blank
Blank_ID=999; % blank is represented as 99
VAR_THREHOLD=0.02;
NCOND=60;
% sel=find(imgpairs(:,2)==Blank_ID);
% imgpairs=imgpairs(sel,:);

pairs=pairs(1:NCOND);
triplets=triplets(1:NCOND);
imgpairs=imgpairs(1:NCOND,:);
imgtrips=imgtrips(1:NCOND,:);
stim=[singletons;pairs;triplets];

s_ind=1:length(singletons);
p_ind=(1:length(pairs));
t_ind=(1:length(triplets));

% parameters
type{1}='imagenet-vgg-verydeep-16';
N=length(stim);% number of unique parameters
run(run_path);
%%  FINDING VISUALLY ACTIVE NEURONS
% extract features for all the singletons.
iter=1;
% Extracting Features
net = load(type{iter}) ;
net = vl_simplenn_tidy(net);
nimages=length(singletons);
features_singleton={nimages,1};
for i=1:nimages
    bimage_ip=single(singletons{i});
    if size(bimage_ip,3)==1, bimage_ip = repmat(bimage_ip,1,1,3); end
    cimage=imresize(bimage_ip,net.meta.normalization.imageSize(1:2));
    cimage=cimage-net.meta.normalization.averageImage;
    features_singleton{i}=vl_simplenn(net,cimage);
end

group=1:length(singletons);
group=reshape(group,[length(singletons)/3,3]); % grouping the simgileton images according to position

VAN=[];
layerid=37;
fprintf('\n Layer %d',layerid);
% extracting response and normalizing
nNeurons=length(vec(features_singleton{1}(layerid).x));% number of neurons
nNeu(layerid)=nNeurons;
response=zeros(nNeurons,nimages); % initializing the matrix
for ind=1:nimages
    response(:,ind)=vec(features_singleton{ind}(layerid).x); % extracting the response
end
response=normalize(response','range');response=response'; % normalizing
rg1=response(:,group(:,1));rg2=response(:,group(:,2));rg3=response(:,group(:,3));

van=find(var(rg1,0,2)>VAR_THREHOLD &var(rg2,0,2)>VAR_THREHOLD &var(rg3,0,2)>VAR_THREHOLD); %visually active neurons
nVAN(layerid)=length(van);
VAN{layerid}=van;

%% Extracting Features
fprintf('\nCalculating for %s',type{iter});
net = load(type{iter}) ;
net = vl_simplenn_tidy(net);
% pairs
nimages=length(pairs);
features_pairs={nimages,1};
for i=1:nimages
    bimage_ip=single(pairs{i});
    if size(bimage_ip,3)==1, bimage_ip = repmat(bimage_ip,1,1,3); end
    cimage=imresize(bimage_ip,net.meta.normalization.imageSize(1:2));
    cimage=cimage-net.meta.normalization.averageImage;
    features_pairs{i}=vl_simplenn(net,cimage);
end
% triplets
nimages=length(triplets);
features_triplets={nimages,1};
for i=1:nimages
    bimage_ip=single(triplets{i});
    if size(bimage_ip,3)==1, bimage_ip = repmat(bimage_ip,1,1,3); end
    cimage=imresize(bimage_ip,net.meta.normalization.imageSize(1:2));
    cimage=cimage-net.meta.normalization.averageImage;
    features_triplets{i}=vl_simplenn(net,cimage);
end

%% Pairs
layers=37; % Layer number
fprintf('\n Layers %s',num2str(layers));
Fp=[];Fsum=[];F1=[]; F2=[]; % init
for ind=1:length(imgpairs) % across image pairs
    f=cell(2,1);count=0;% init
    for p=1:3 % position, expecting stimuli only in two positions
        if(imgpairs(ind,p)~=Blank_ID)
            count=count+1;
            sel_index=find(imgsingles(:,p)==imgpairs(ind,p));
            temp=features_singleton{s_ind(sel_index)};
            f{count}=vec(temp(layers).x);
        end
    end
    Fp(:,ind)=vec(features_pairs{p_ind(ind)}(layers).x);
    Fsum(:,ind)=f{1}+f{2};
    F1(:,ind)=f{1};F2(:,ind)=f{2};
end
Fp=Fp(VAN{layers},:);
Fsum=Fsum(VAN{layers},:);
F1=F1(VAN{layers},:);
F2=F2(VAN{layers},:);

% find the correlation across image pairs for each VAN
[r_mean,r_sem]= find_composionality(Fp,Fsum,cat(3,F1,F2));
composionlaity_pairs(:,layers)=r_mean;
composionlaity_pairs_sem(:,layers)=r_sem;
if(layers==37)
    Fsum37_pairs=Fsum;
    Fp37_pairs=Fp;
end
%% Triplets
Ft=[];Fsum=[]; F1=[];F2=[];F3=[];% init
for ind=1:length(imgtrips) % across image pairs
    f=cell(3,1);
    for p=1:3 % position, expecting stimuli only in two positions
        sel_index=find(imgsingles(:,p)==imgtrips(ind,p));
        f{p}=vec(features_singleton{s_ind(sel_index)}(layers).x);
    end
    Ft(:,ind)=vec(features_triplets{t_ind(ind)}(layers).x);
    Fsum(:,ind)=f{1}+f{2}+f{3};
    F1(:,ind)=f{1};F2(:,ind)=f{2};F3(:,ind)=f{3};
end
Ft=Ft(VAN{layers},:);
Fsum=Fsum(VAN{layers},:);
% find the correlation across image pairs for each VAN
[r_mean,r_sem]= find_composionality(Ft,Fsum,cat(3,F1,F2));
composionlaity_triplets(:,layers)=r_mean;
composionlaity_triplets_sem(:,layers)=r_sem;
if(layers==37)
    Fsum37_triplets=Fsum;
    Fp37_triplets=Ft;
end

%% Plotting
% 5 percent data points
%sel_index=randperm(length(Fsum37_pairs(:)),2694);sel_index=sort(sel_index);
sel_index=[23,30,54,78,100,156,278,322,329,332,339,341,445,463,513,525,565,566,570,583,629,637,647,656,680,720,736,739,766,772,777,785,826,832,855,857,882,904,913,919,923,936,943,944,948,972,981,1049,1084,1096,1104,1109,1117,1157,1202,1203,1216,1253,1287,1296,1315,1332,1395,1399,1407,1413,1417,1419,1421,1467,1482,1528,1557,1595,1600,1632,1643,1647,1661,1668,1701,1738,1780,1792,1823,1835,1871,1907,1909,1916,1970,1976,1981,1988,2053,2060,2061,2097,2114,2124,2162,2181,2208,2255,2267,2277,2281,2314,2347,2350,2369,2413,2424,2430,2440,2452,2475,2545,2546,2548,2551,2562,2575,2578,2608,2615,2633,2668,2672,2677,2679,2685,2720,2724,2731,2734,2739,2740,2755,2781,2806,2814,2831,2853,2899,2908,2940,2966,2967,2971,3005,3114,3125,3131,3133,3155,3157,3181,3220,3225,3277,3324,3364,3365,3383,3387,3395,3409,3416,3437,3445,3449,3457,3464,3479,3482,3561,3575,3604,3625,3648,3658,3660,3674,3689,3742,3748,3752,3779,3814,3823,3838,3870,3881,3888,3898,3940,3958,3961,3972,4007,4035,4049,4084,4087,4107,4124,4140,4169,4186,4194,4222,4235,4238,4255,4285,4311,4318,4353,4423,4426,4440,4460,4493,4499,4506,4513,4539,4545,4549,4573,4582,4587,4606,4608,4616,4620,4635,4645,4672,4688,4763,4776,4805,4806,4850,4856,4878,4897,4903,4912,4932,4937,4961,4965,4973,4980,4986,5005,5010,5027,5048,5060,5075,5116,5120,5123,5124,5129,5136,5142,5160,5172,5188,5199,5239,5293,5303,5311,5324,5360,5362,5385,5445,5454,5455,5471,5484,5485,5487,5488,5534,5567,5623,5635,5648,5658,5662,5762,5766,5776,5781,5799,5807,5808,5834,5847,5856,5857,5859,5901,5911,5933,5984,5986,5989,6021,6025,6039,6049,6064,6113,6155,6172,6218,6219,6232,6253,6276,6279,6322,6335,6354,6398,6399,6404,6425,6429,6436,6484,6507,6520,6533,6545,6561,6612,6614,6655,6666,6684,6691,6701,6706,6722,6757,6764,6787,6791,6794,6838,6886,6918,6947,6982,6992,7028,7031,7034,7040,7043,7068,7076,7143,7151,7171,7188,7198,7201,7204,7219,7251,7378,7417,7423,7458,7459,7467,7503,7539,7550,7563,7653,7667,7683,7693,7816,7840,7846,7869,7876,7894,7903,7922,7984,8000,8025,8030,8044,8047,8067,8070,8071,8082,8102,8120,8178,8203,8253,8284,8290,8344,8348,8350,8357,8391,8428,8435,8454,8462,8485,8512,8521,8533,8545,8557,8559,8567,8580,8592,8593,8645,8649,8650,8666,8685,8714,8717,8764,8773,8779,8781,8874,8884,8960,8991,9020,9041,9048,9084,9116,9128,9176,9211,9264,9265,9274,9280,9281,9319,9341,9376,9388,9425,9430,9470,9485,9489,9534,9553,9584,9586,9597,9610,9612,9664,9703,9706,9707,9723,9724,9757,9761,9765,9795,9843,9858,9908,9928,9935,9982,9995,9999,10008,10013,10018,10021,10030,10058,10073,10099,10117,10149,10150,10156,10158,10191,10203,10212,10293,10309,10316,10341,10354,10368,10376,10380,10389,10432,10449,10451,10456,10464,10479,10480,10535,10537,10558,10560,10597,10628,10645,10678,10683,10725,10738,10747,10795,10822,10830,10831,10842,10853,10907,10934,10947,10964,10998,11029,11031,11048,11073,11077,11091,11121,11165,11172,11175,11177,11180,11203,11212,11271,11283,11330,11375,11390,11392,11444,11453,11513,11518,11528,11534,11547,11597,11648,11665,11704,11727,11741,11745,11776,11780,11794,11816,11825,11835,11851,11857,11876,11893,11928,11940,11963,11972,11980,12012,12030,12072,12078,12095,12156,12162,12169,12173,12189,12191,12218,12240,12277,12288,12311,12319,12328,12343,12357,12371,12373,12380,12381,12388,12391,12407,12418,12426,12459,12465,12486,12562,12579,12581,12588,12595,12596,12603,12604,12705,12740,12805,12818,12829,12898,12914,12925,12945,12946,12955,13001,13057,13065,13072,13078,13086,13089,13101,13111,13125,13141,13145,13160,13164,13168,13172,13184,13209,13254,13262,13326,13352,13362,13367,13370,13382,13442,13460,13472,13493,13494,13516,13533,13543,13551,13556,13602,13703,13704,13714,13755,13781,13802,13815,13847,13878,13882,13907,13914,13928,13938,13941,13948,13963,13967,13978,14005,14012,14023,14049,14055,14144,14148,14164,14170,14194,14212,14231,14243,14244,14296,14316,14331,14362,14373,14379,14414,14456,14460,14506,14550,14555,14584,14619,14630,14637,14639,14645,14648,14677,14708,14727,14754,14756,14771,14810,14844,14846,14860,14889,14906,14914,14934,14944,14962,14968,14977,14995,14997,15004,15022,15028,15042,15072,15105,15143,15156,15178,15182,15218,15248,15293,15295,15311,15325,15350,15441,15465,15467,15483,15490,15499,15516,15542,15572,15590,15597,15644,15664,15691,15702,15745,15757,15776,15786,15788,15792,15804,15813,15841,15846,15855,15858,15863,15872,15897,15936,15950,15962,15987,15997,16014,16026,16051,16070,16101,16103,16125,16131,16140,16180,16194,16202,16205,16206,16210,16243,16274,16280,16308,16329,16391,16450,16512,16542,16555,16664,16682,16692,16712,16729,16771,16772,16792,16874,16895,16898,16902,16938,16957,16998,17004,17006,17030,17036,17082,17092,17094,17098,17138,17179,17183,17194,17197,17226,17245,17250,17259,17261,17278,17283,17316,17336,17350,17374,17378,17418,17436,17514,17520,17526,17542,17599,17603,17616,17634,17649,17652,17659,17666,17671,17685,17702,17706,17776,17782,17828,17837,17853,17934,17948,17976,17979,18004,18009,18038,18042,18067,18078,18170,18183,18202,18223,18226,18242,18318,18321,18353,18380,18384,18393,18424,18469,18472,18478,18479,18526,18544,18553,18559,18567,18573,18595,18622,18647,18669,18675,18741,18760,18768,18769,18790,18804,18842,18845,18848,18861,18865,18871,18923,19019,19028,19037,19040,19063,19094,19107,19133,19212,19214,19215,19222,19226,19242,19254,19275,19306,19338,19379,19453,19466,19504,19518,19549,19602,19618,19619,19621,19634,19650,19705,19718,19723,19731,19740,19743,19751,19769,19770,19773,19784,19818,19829,19839,19842,19856,19864,19870,19927,19954,19989,20000,20021,20022,20032,20042,20052,20058,20079,20088,20096,20112,20123,20156,20172,20193,20202,20214,20317,20325,20378,20384,20438,20476,20484,20493,20503,20508,20548,20621,20624,20673,20695,20702,20718,20739,20761,20794,20821,20853,20860,20863,20893,20918,20932,20938,20947,20956,20972,20973,20994,20995,21004,21012,21026,21112,21189,21214,21219,21232,21252,21271,21277,21287,21292,21296,21325,21331,21373,21407,21430,21446,21462,21474,21481,21563,21582,21587,21605,21607,21633,21645,21647,21709,21717,21725,21727,21737,21753,21786,21829,21845,21858,21880,21883,21899,21908,21945,21964,22020,22032,22051,22086,22091,22113,22134,22147,22162,22213,22241,22245,22294,22305,22329,22335,22344,22368,22391,22419,22467,22514,22517,22550,22664,22677,22697,22740,22745,22749,22757,22772,22805,22816,22826,22853,22888,22914,22920,22922,22937,22957,22971,22975,22985,22996,23024,23089,23145,23169,23218,23222,23228,23266,23272,23311,23323,23344,23352,23406,23407,23416,23422,23435,23488,23492,23515,23538,23542,23556,23610,23641,23676,23678,23710,23727,23730,23738,23748,23771,23796,23834,23838,23848,23858,23882,23910,23922,23929,23936,23959,23971,23981,24001,24014,24040,24066,24078,24085,24093,24101,24103,24104,24106,24155,24197,24215,24227,24244,24246,24262,24290,24298,24348,24415,24464,24465,24501,24520,24549,24563,24565,24572,24596,24650,24671,24676,24679,24688,24701,24709,24717,24740,24765,24769,24791,24799,24834,24870,24872,24879,24950,24961,24985,25019,25052,25064,25071,25102,25117,25171,25206,25224,25225,25257,25260,25266,25268,25295,25311,25312,25359,25370,25378,25387,25389,25404,25434,25437,25448,25572,25586,25613,25618,25640,25668,25677,25712,25825,25830,25844,25845,25850,25855,25856,25867,25899,25908,25925,25926,25933,25956,26007,26033,26065,26066,26070,26072,26073,26078,26087,26106,26113,26149,26152,26164,26165,26167,26230,26240,26242,26293,26295,26316,26343,26362,26378,26382,26412,26459,26465,26485,26486,26501,26503,26518,26521,26530,26593,26613,26623,26641,26644,26695,26713,26718,26745,26778,26786,26814,26842,26954,26971,26979,27003,27007,27073,27075,27085,27188,27203,27231,27261,27298,27311,27368,27373,27402,27428,27433,27464,27579,27605,27611,27644,27685,27722,27741,27794,27799,27822,27853,27875,27882,27911,27975,27989,28059,28060,28064,28075,28088,28089,28100,28107,28154,28254,28274,28285,28299,28304,28305,28311,28312,28323,28334,28358,28366,28376,28396,28453,28454,28506,28515,28541,28550,28564,28592,28597,28608,28614,28615,28667,28677,28686,28692,28697,28718,28722,28731,28757,28767,28771,28776,28795,28855,28888,28896,28932,28939,28958,28981,28995,29010,29013,29018,29026,29052,29063,29081,29096,29143,29158,29182,29192,29194,29203,29213,29230,29266,29267,29273,29277,29307,29312,29337,29341,29360,29404,29412,29419,29458,29460,29475,29491,29498,29522,29525,29559,29577,29589,29633,29667,29669,29680,29684,29702,29717,29729,29746,29753,29765,29773,29802,29811,29812,29867,29900,29965,29970,29971,29981,30001,30007,30019,30025,30039,30057,30065,30108,30115,30153,30160,30183,30189,30212,30218,30226,30228,30251,30258,30268,30269,30335,30410,30418,30443,30482,30489,30497,30563,30604,30649,30654,30682,30753,30759,30766,30775,30826,30863,30865,30866,30885,30901,30906,30908,30915,30932,30961,30983,30993,31012,31018,31020,31024,31037,31099,31105,31107,31123,31127,31136,31173,31179,31183,31188,31231,31275,31295,31298,31305,31314,31357,31387,31437,31445,31446,31508,31509,31628,31630,31641,31711,31716,31725,31779,31807,31833,31840,31843,31846,31854,31884,31889,31896,31901,31902,31905,31926,31949,31977,32014,32157,32197,32203,32224,32271,32282,32322,32326,32331,32345,32352,32378,32391,32392,32409,32435,32441,32484,32499,32506,32519,32567,32589,32593,32595,32631,32638,32640,32698,32705,32756,32784,32797,32802,32809,32822,32909,32933,32950,32952,32956,32969,32978,32993,33000,33027,33029,33034,33043,33063,33064,33080,33120,33121,33149,33202,33229,33264,33294,33300,33303,33330,33369,33394,33402,33412,33413,33440,33469,33477,33482,33524,33568,33575,33576,33600,33615,33634,33638,33646,33695,33699,33752,33769,33774,33789,33835,33874,33885,33918,33930,33932,33939,33962,33973,34022,34028,34054,34058,34098,34149,34166,34171,34177,34198,34202,34244,34278,34284,34309,34317,34327,34335,34342,34343,34356,34372,34375,34385,34387,34399,34425,34437,34477,34503,34523,34530,34533,34539,34546,34583,34594,34605,34606,34610,34626,34644,34672,34677,34687,34716,34721,34731,34734,34764,34767,34776,34805,34829,34844,34875,34881,34883,34892,34946,34952,34953,34988,35029,35046,35061,35068,35080,35094,35110,35127,35147,35160,35172,35176,35177,35196,35217,35243,35252,35316,35327,35337,35339,35346,35356,35405,35412,35472,35484,35494,35501,35524,35551,35571,35582,35587,35603,35605,35611,35626,35630,35640,35680,35705,35711,35776,35814,35815,35817,35821,35839,35907,35908,35922,35953,35967,35982,35984,35991,35992,35997,36020,36054,36067,36089,36096,36103,36114,36151,36200,36205,36216,36236,36255,36262,36263,36275,36279,36290,36291,36300,36317,36385,36411,36424,36471,36507,36546,36557,36593,36613,36648,36679,36688,36717,36741,36778,36783,36786,36794,36800,36806,36850,36851,36865,36875,36882,36895,36908,36987,36994,37009,37010,37028,37042,37077,37123,37148,37152,37165,37167,37175,37194,37199,37236,37239,37242,37280,37291,37297,37307,37331,37346,37349,37352,37384,37387,37399,37410,37428,37442,37451,37471,37486,37513,37519,37547,37549,37580,37585,37590,37598,37625,37628,37650,37657,37661,37664,37686,37712,37759,37825,37930,37969,37972,37990,38016,38021,38079,38093,38097,38099,38133,38142,38161,38180,38200,38216,38273,38300,38327,38342,38345,38397,38405,38424,38433,38435,38441,38445,38452,38455,38456,38465,38549,38553,38569,38579,38613,38622,38756,38760,38780,38827,38837,38854,38855,38912,38951,39044,39049,39099,39147,39175,39188,39216,39228,39235,39246,39250,39277,39280,39301,39332,39377,39388,39389,39408,39443,39459,39474,39477,39494,39499,39500,39508,39512,39561,39564,39566,39583,39592,39687,39688,39699,39700,39839,39849,39870,39889,39908,39927,39995,40003,40056,40067,40072,40079,40086,40189,40244,40281,40298,40336,40380,40395,40433,40444,40457,40487,40505,40526,40549,40556,40595,40622,40672,40684,40701,40730,40773,40780,40794,40801,40821,40845,40853,40919,40927,40981,40987,41002,41007,41016,41024,41045,41054,41056,41082,41124,41189,41212,41225,41233,41256,41266,41297,41314,41315,41322,41326,41358,41365,41384,41407,41442,41449,41450,41481,41492,41508,41511,41517,41523,41530,41555,41556,41598,41615,41628,41738,41744,41761,41763,41775,41787,41794,41807,41815,41824,41825,41826,41843,41849,41868,41897,41899,41905,41912,41914,41930,41942,41949,41950,41959,41961,41965,42024,42050,42066,42073,42075,42091,42100,42101,42110,42141,42207,42274,42285,42287,42356,42357,42359,42368,42371,42384,42394,42412,42443,42457,42462,42486,42493,42558,42581,42588,42605,42629,42643,42662,42669,42694,42717,42741,42755,42759,42763,42772,42778,42780,42808,42818,42849,42909,42925,42943,42998,43046,43052,43069,43076,43168,43206,43287,43301,43338,43357,43363,43377,43395,43511,43514,43603,43642,43652,43655,43702,43734,43735,43744,43776,43779,43780,43786,43789,43807,43815,43844,43930,43933,43957,43963,43991,44031,44037,44086,44101,44105,44155,44187,44189,44233,44247,44276,44282,44290,44360,44385,44394,44520,44521,44554,44573,44632,44642,44654,44663,44680,44705,44711,44747,44750,44784,44788,44794,44834,44840,44863,44890,44898,44899,44900,44942,44950,44965,44976,44985,45013,45018,45037,45046,45071,45072,45078,45091,45106,45138,45146,45158,45162,45171,45172,45175,45232,45244,45247,45248,45278,45289,45306,45319,45321,45336,45339,45357,45364,45367,45374,45381,45388,45389,45415,45433,45435,45460,45492,45497,45510,45563,45579,45581,45633,45654,45663,45666,45675,45701,45753,45770,45782,45817,45821,45895,45914,45929,45978,45989,45991,46006,46020,46022,46035,46057,46075,46082,46125,46141,46150,46151,46154,46156,46213,46242,46245,46260,46273,46286,46291,46313,46322,46347,46391,46412,46414,46430,46506,46531,46542,46573,46575,46576,46607,46610,46623,46630,46637,46646,46650,46675,46710,46744,46774,46817,46834,46845,46872,46878,46908,46936,46939,46966,47023,47030,47043,47057,47126,47165,47170,47176,47181,47192,47227,47241,47254,47259,47265,47278,47285,47289,47304,47335,47337,47349,47458,47467,47481,47505,47506,47544,47549,47559,47570,47571,47596,47600,47626,47642,47656,47658,47667,47670,47684,47707,47736,47748,47779,47796,47802,47816,47833,47837,47843,47866,47891,47899,47902,47957,47958,47961,47967,47985,48033,48057,48080,48082,48085,48088,48093,48153,48156,48198,48239,48240,48254,48255,48307,48329,48336,48357,48381,48394,48403,48417,48443,48475,48498,48556,48589,48626,48634,48646,48649,48655,48662,48676,48694,48750,48792,48794,48804,48808,48822,48826,48830,48879,48885,48901,48909,48956,48980,49007,49063,49065,49101,49107,49116,49129,49137,49146,49165,49197,49250,49290,49299,49315,49350,49373,49412,49427,49453,49454,49539,49544,49635,49682,49683,49706,49740,49770,49773,49803,49852,49857,49888,49894,49901,49925,49953,49964,49995,49999,50003,50007,50051,50103,50119,50140,50178,50182,50190,50223,50225,50227,50236,50257,50271,50336,50407,50423,50467,50498,50501,50517,50576,50584,50610,50669,50671,50675,50706,50712,50743,50750,50806,50811,50816,50824,50832,50871,50872,50897,50988,51036,51057,51118,51131,51168,51195,51216,51250,51255,51263,51268,51290,51308,51310,51353,51363,51433,51478,51479,51499,51517,51523,51536,51551,51554,51560,51562,51563,51574,51580,51613,51620,51628,51678,51709,51712,51741,51748,51784,51796,51829,51858,51872,51894,51896,51905,52000,52034,52051,52077,52108,52128,52129,52155,52168,52170,52171,52180,52186,52191,52216,52235,52269,52298,52321,52325,52347,52365,52383,52384,52425,52436,52450,52465,52479,52506,52526,52553,52558,52567,52598,52610,52612,52615,52628,52660,52739,52740,52752,52756,52769,52772,52857,52862,52866,52867,52886,52889,52924,52929,52933,52951,52961,52991,53037,53042,53050,53062,53110,53120,53135,53187,53194,53203,53236,53247,53263,53336,53340,53357,53367,53410,53420,53422,53449,53478,53486,53528,53531,53540,53590,53597,53600,53628,53664,53674,53739,53756,53775,53803,53817,53826,53831,53861,53863,53864];
figure;
corrplot(Fsum37_triplets(sel_index),Fp37_triplets(sel_index),[],1,'.r')

corrplot(Fsum37_pairs(sel_index),Fp37_pairs(sel_index),[],1,'.b')
xlim([-10,15]);
ylim([-10,15]);

h=gca;
h.XTick=[-10,0,15];
h.YTick=[-10,0,15];

xlabel('Sum of responses to single objects, arbitary units');
ylabel('Response to combined image')

%% Position Invariance Analysis
% figure;
% neurons=[50,100];
% plot(X(neurons,:)');
% ylabel('response to single images');
% xlabel('49 images at pos1(1-49), pos2(50-98), pos3(99-147)')
% title(type{1})
% line([49.5,49.5],[min(X(1,:)),max(X(1,:))],'Color','red','LineStyle','--')
% line([98.5,98.5],[min(X(1,:)),max(X(1,:))],'Color','red','LineStyle','--')
% legend({['neuron = ',num2str(neurons(1))],['neuron = ',num2str(neurons(2))]})
% 
% figure;
% corrplot(X(neurons(1),1:49),X(neurons(1),49+(1:49)),['Neuron -',num2str(neurons(1))],1)
% xlabel('Image Activation of 1-49');ylabel('Image Activations of 50-98');
% %%
% layers=37;
% for i=1:147
%     X(:,i)=vec(features_singleton{s_ind(i)}(layers).x);
% end
% 
% %X=X/(10^26);
% for i=1:1000
% x=X(i,1:49);
% y=X(i,49+(1:49));
% xx(i)=nancorrcoef(x,y);
% end
% sprintf('\nMean = %.4f, sem = %.4f',nanmean((xx)),nansem(vec(xx)))
% 
% 
% %%
% figure;
% image_no=[1,5,10,15];
% plot(X(1:100,image_no))
% ylabel('response to single images');
% xlabel('100 neurons from Layer 37')
% title(type{1})
% legend(num2str(image_no'),'Location','best')
